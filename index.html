<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Monitor Web</title>
    <style>
        /* --- Estilos Avanzados v2.0 --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #334155;
            --heading-color: #0f172a;
            --border-color: #e2e8f0;
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --status-up: #10b981;
            --status-down: #ef4444;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        main {
            padding: 2em;
            max-width: 960px;
            margin: 2em auto;
        }
        
        /* --- Estilos de Autenticación --- */
        #auth-view {
            max-width: 400px;
            margin: 4em auto;
            padding: 2.5em;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .auth-form h2 {
            color: var(--heading-color);
            margin-bottom: 1.5em;
        }

        .input-group {
            margin-bottom: 1.5em;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5em;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .input-group input {
            width: 100%;
            padding: 0.75em;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }

        .auth-button {
            width: 100%;
            padding: 0.875em;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .auth-button:hover {
            background-color: var(--primary-hover);
        }
        
        #auth-toggle {
            margin-top: 1.5em;
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 500;
        }
        
        /* --- Estilos del Dashboard --- */
        #dashboard-view {
            display: none; /* Oculto por defecto */
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1em;
            margin-bottom: 2em;
        }

        #logout-button {
            padding: 0.5em 1em;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: transparent;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        #logout-button:hover {
            background-color: #f1f5f9;
        }
        
        #status-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: opacity 0.5s ease-in-out;
        }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 16px 20px; text-align: left; border-bottom: 1px solid var(--border-color); }
        thead th { background-color: #f8fafc; font-size: 0.875rem; text-transform: uppercase; color: #64748b; font-weight: 600; }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover { background-color: #f8fafc; }
        td:first-child { font-weight: 600; color: var(--heading-color); }

        .status-cell { display: flex; align-items: center; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; }
        .up { color: var(--status-up); font-weight: 700; }
        .up .status-indicator { background-color: var(--status-up); }
        .down { color: var(--status-down); font-weight: 700; }
        .down .status-indicator { background-color: var(--status-down); }

        .message-container { padding: 4em; text-align: center; font-size: 1.125rem; color: #64748b; }
        .error-message { color: var(--status-down); font-weight: 500; margin-top: 1em; }

    </style>
</head>
<body>
    <main>
        <div id="auth-view">
            <form id="auth-form" class="auth-form">
                <h2 id="auth-title">Crear una cuenta</h2>
                <div class="input-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required />
                </div>
                <div class="input-group">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" required />
                </div>
                <button type="submit" class="auth-button" id="auth-button">Crear cuenta</button>
            </form>
            <button id="auth-toggle">¿Ya tienes una cuenta? Inicia sesión</button>
            <div id="auth-error" class="error-message"></div>
        </div>

        <div id="dashboard-view">
            <header>
                <div>
                    <h1>Dashboard del Monitor Web</h1>
                    <p id="welcome-message"></p>
                </div>
                <button id="logout-button">Cerrar Sesión</button>
            </header>
            
            <div id="status-container">
                <table>
                    <thead>
                        <tr>
                            <th>Sitio Web</th>
                            <th>Estado</th>
                            <th>Tiempo de Resp.</th>
                            <th>Fecha de Verificación</th>
                        </tr>
                    </thead>
                    <tbody id="checks-table-body"></tbody>
                </table>
                <div id="message-container" class="message-container">Cargando datos...</div>
            </div>
        </div>
    </main>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

        // --- ¡ACCIÓN REQUERIDA! ---
        const SUPABASE_URL = 'https://mnsxmbrovvyafcgetbpz.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1uc3htYnJvdnZ5YWZjZ2V0YnB6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAzNzQ3MDcsImV4cCI6MjA2NTk1MDcwN30.C6o3XCvbGDWggTatwdctu6sNc37YD5hARMgeahnMPLk'

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Selectores del DOM ---
        const authView = document.getElementById('auth-view');
        const dashboardView = document.getElementById('dashboard-view');
        const authForm = document.getElementById('auth-form');
        const authButton = document.getElementById('auth-button');
        const authTitle = document.getElementById('auth-title');
        const authToggle = document.getElementById('auth-toggle');
        const authError = document.getElementById('auth-error');
        const logoutButton = document.getElementById('logout-button');
        const welcomeMessage = document.getElementById('welcome-message');
        const tableBody = document.getElementById('checks-table-body');
        const messageContainer = document.getElementById('message-container');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');

        let isLogin = false;

        // --- Lógica de Autenticación ---

        // Cambiar entre modo Login y Registro
        authToggle.addEventListener('click', () => {
            isLogin = !isLogin;
            authTitle.textContent = isLogin ? 'Iniciar Sesión' : 'Crear una cuenta';
            authButton.textContent = isLogin ? 'Iniciar Sesión' : 'Crear cuenta';
            authToggle.textContent = isLogin ? '¿No tienes una cuenta? Regístrate' : '¿Ya tienes una cuenta? Inicia sesión';
            authError.textContent = '';
        });
        
        // Manejar envío del formulario de Login/Registro
        authForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            authError.textContent = '';
            const email = emailInput.value;
            const password = passwordInput.value;
            let error;

            if (isLogin) {
                const { error: signInError } = await supabase.auth.signInWithPassword({ email, password });
                error = signInError;
            } else {
                const { error: signUpError } = await supabase.auth.signUp({ email, password });
                error = signUpError;
                if (!error) {
                    alert('¡Registro exitoso! Por favor, revisa tu correo para confirmar tu cuenta.');
                }
            }

            if (error) {
                authError.textContent = error.message;
            }
        });

        // Manejar cierre de sesión
        logoutButton.addEventListener('click', async () => {
            await supabase.auth.signOut();
        });

        // --- Lógica del Dashboard ---

        async function fetchData(userId) {
            messageContainer.textContent = 'Cargando datos...';
            try {
                // Ahora filtramos por el user_id del usuario que ha iniciado sesión
                const { data, error } = await supabase
                    .from('status_checks')
                    .select(`id, created_at, status_text, response_time_ms, websites!inner ( url )`)
                    .eq('websites.user_id', userId) // ¡El filtro de seguridad!
                    .order('created_at', { ascending: false })
                    .limit(20);

                if (error) throw error;
                
                tableBody.innerHTML = ''; 

                if (data.length === 0) {
                    messageContainer.textContent = 'No tienes sitios monitoreados o aún no hay verificaciones.';
                } else {
                    messageContainer.style.display = 'none';
                }

                for (const check of data) {
                     const row = document.createElement('tr');
                    const statusClass = check.status_text === 'UP' ? 'up' : 'down';
                    row.innerHTML = `
                        <td>${check.websites ? check.websites.url : 'URL no encontrada'}</td>
                        <td class="${statusClass}"><div class="status-cell"><span class="status-indicator"></span><span>${check.status_text}</span></div></td>
                        <td>${check.response_time_ms} ms</td>
                        <td>${new Date(check.created_at).toLocaleString('es-CL')}</td>
                    `;
                    tableBody.appendChild(row);
                }
            } catch (err) {
                messageContainer.innerHTML = `<span class="error">Error al cargar los datos: ${err.message}</span>`;
                console.error(err);
            }
        }
        
        // --- Controlador Principal de Sesión ---

        supabase.auth.onAuthStateChange((event, session) => {
            if (session && session.user) {
                // Usuario ha iniciado sesión
                authView.style.display = 'none';
                dashboardView.style.display = 'block';
                welcomeMessage.textContent = `Bienvenido, ${session.user.email}`;
                fetchData(session.user.id);
            } else {
                // Usuario no ha iniciado sesión
                authView.style.display = 'block';
                dashboardView.style.display = 'none';
            }
        });

    </script>
</body>
</html>